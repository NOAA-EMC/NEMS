<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.5"/>
<title>NEMS: Configuring</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
  $(window).load(resizeHeight);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="make-images-fit.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">NEMS
   &#160;<span id="projectnumber">feature/documentation@6b989eaee9</span>
   </div>
   <div id="projectbrief">This is a living document and may be updated at any time.</div>
  </td>
   <td>        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
</td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.5 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('configuring.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Pages</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">Configuring </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>The coupled NEMS application is highly configurable. During build-time, i.e. when the NEMS executable is being compiled and linked, choices are made as to which model and mediator components are built into the system. The built-in components become accessible during run-time, allowing the execution of different run configurations without the need to rebuild NEMS.</p>
<p>Often the build and run configurability of NEMS is hidden from the user by application or test scripts. However, there are times where it is useful to understand the technical details on the level of the NEMS executable.</p>
<h2>Build Configuration </h2>
<p>The NEMS build configuration is accessible through the GNU Make based build system.</p>
<p>The ocean, sea-ice, ionosphere-plasmasphere model, hydraulic model, and wave components that are built into the NEMS executable are picked via the OCN, ICE, IPM, HYD, and WAV variables, respectively. Each of these variables is a comma separated list of models that can be specified on the make command line. The currently available options for each variable are shown below:</p>
<ul>
<li><code>ATM = satm, xatm, datm, gsm, fv3</code></li>
<li><code>LND = slnd, xlnd, lis</code></li>
<li><code>OCN = socn, xocn, mom5, hycom, pom</code></li>
<li><code>ICE = sice, xice, cice</code></li>
<li><code>WAV = swav, xwav, ww3</code></li>
<li><code>IPM = sipm, xipm, ipe</code></li>
<li><code>HYD = shyd, xhyd, wrfhydro</code></li>
</ul>
<p>In addition, the Common Community Physics Package (CCPP) and the Flexible Modeling System (FMS) are presented as components for the purposes of compilation of the NEMS executable.</p>
<p>For each model type the current non-active instance options are listed below. The definition of these two options is similar to their use in the <a href="http://www2.cesm.ucar.edu/">Community Earth System Model (CESM)</a>:</p>
<ul>
<li><b>Stub components</b> conform to the <a href="https://earthsystemcog.org/projects/nuopc/compliance_testing">NUOPC rules for model components</a>. They do not advertise any fields in their <code>importState</code> or <code>exportState</code>. Their primary use is to test control flow between components in a driver.</li>
<li><b>Dead components</b> conform to the NUOPC rules for model components. They advertise fields in the <code>importState</code> and <code>exportState</code> that are appropriate for the specific model type. Import fields may be ignored internally. Export fields are filled with data that changes during time stepping, but has no scientific relevance. Their primary use is in coupled systems with other dead components to test the data transfers between components.</li>
</ul>
<p>All of the variables support the specification of multiple options via comma separated list on the right-hand side. The default target of the NEMS makefile (i.e. no target specified) will print out a list of options with explanation to assist the user with the build configuration.</p>
<h2>Run Configuration </h2>
<p>During run-time of the NEMS executable, it accesses a file called nems.configure, which it expects to find in the run directory. This file specifies the dynamic component selection, and the exact run sequence to be used. Only models built into the executable at build-time are accessible during run-time. An error will be triggered if an unavailable model is selected in nems.configure. The component selection is based on two variables: </p>
<pre class="fragment">xxx_model:          abc
xxx_petlist_bounds: lower upper
</pre><p>Here <code>xxx</code> can be <code>atm</code>, <code>ocn</code>, <code>ice</code>, <code>ipm</code>, <code>med</code>. The <code>abc</code> stands for the actual instance name, e.g. <code>fv3</code> or <code>mom5</code>. The lower and upper bounds of the petList specification are integer PET numbers.</p>
<p>The specification of the run sequence provides the flexibility needed to cover different coupling scenarios. The format is line based between special tags: </p>
<pre class="fragment">runSeq::
    line1
    line2
    ...
    lineN
::
</pre><p>There are a number of format options for each line:</p>
<ul>
<li>A time loop is introduced by a <code>@</code> symbol, followed immediatly by the number of seconds of the associated time step.</li>
<li>A time loop is closed by a single <code>@</code> symbol on a line.</li>
<li>The <code>RUN</code> method of model component <code>xxx</code> is called by specifying just <code>xxx</code> on a line. The supported values of <code>xxx</code> are the same as for the model specification above. A specific RUN phase can be provided by adding the phase label to the same line, following the model string.</li>
<li>A connector going from component <code>xxx</code> to component <code>yyy</code> is specified by a line like this: <code>xxx -&gt; yyy</code>. An additional argument on the same line can be used to specify connection options for all of the field handled by the connector. The format and supported values of the connection options is documented in the NUOPC reference manual.</li>
</ul>
<p>Here is an example of a run sequence specification with two time scales: </p>
<pre class="fragment"># Run Sequence #
runSeq::
    @7200.0
    OCN -&gt; MED
    MED MedPhase_slow
    MED -&gt; OCN
    OCN
    @3600.0
        MED MedPhase_fast_before
        MED -&gt; ATM
        ATM
        ATM -&gt; MED
        MED MedPhase_fast_after
      @
    @
::
</pre><p>Anything on a line after the <code>#</code> symbol is treated as a comment and ignored. Indentation in the formatting does not change the meaning of a line, but is purely used to increase readability.</p>
<h2>8.1 Changing the run sequence </h2>
<p>During run-time of the NEMS executable, it accesses a file called nems.configure, which it expects to find in the run directory. This file specifies the dynamic component selection, and the exact run sequence to be used. Only models built into the executable at build-time are accessible during run-time. An error will be triggered if an unavailable model is selected in nems.configure. The component selection is based on two variables: </p>
<pre class="fragment">xxx_model:         abc

Xxx_petlist_bounds:   lower upper
</pre><p>Here "xxx" can be "atm", "ocn", "ice", "ipm", "med". The "abc" stands for the actual instance name, e.g. "gsm" or "mom5". The lower and upper bounds of the petList specification are integer PET numbers.</p>
<p>The specification of the run sequence provides the flexibility needed to cover different coupling scenarios. The format is line based between special tags: </p>
<pre class="fragment">runSeq::
line1
line2
...
lineN
::
</pre><p>There are a number of format options for each line:</p>
<ul>
<li>A time loop is introduced by a "@" symbol, followed immediatly by the number of seconds of the associated time step.</li>
<li>A time loop is closed by a single "@" symbol on a line.</li>
<li>The RUN method of model component "xxx" is called by specifying just "xxx" on a line. The supported values of "xxx" are the same as for the model specification above. A specific RUN phase can be provided by adding the phase label to the same line, following the model string.</li>
<li>A connector going from component "xxx" to component "yyy" is specified by a line like this: "xxx -&gt; yyy". An additional argument on the same line can be used to specify connection options for all of the field handled by the connector. The format and supported values of the connection options is documented in the NUOPC reference manual.</li>
</ul>
<pre class="fragment">Here is an example of a run sequence specification with two time scales:
#Run Sequence#
runSeq::
    @7200.0
        OCN -&gt; MED
        MED MedPhase_slow
        MED -&gt; OCN
        OCN
        @3600.0
        MED MedPhase_fast_before
        MED -&gt; ATM
        ATM
        ATM -&gt; MED
        MED MedPhase_fast_after
        @
    @
::
</pre><p>Anything on a line after the "#" symbol is treated as a comment and ignored. Indentation in the formatting does not change the meaning of a line, but is purely used to increase readability.</p>
<h2>Adding a model grid with a different resolution </h2>
<p>Changing resolutions in coupled applications is far from an automated process at this point. There are a few reasons for this. One is that each of the components has its own procedure for changing grids, and there is no common interface. There is a constraint that ocean and sea ice grids are the same, which requires a utility to generate ice grids from the ocean grid. Additional utilities are required to generate appropriate initial conditions for all the components on the new grids. Finally, the land masks used by atmosphere, ocean, and sea ice components need to be consistent. This is achieved by having the mediator interpolate the land mask used by the ocean and ice components to the atmosphere grid.</p>
<p>The sequence of steps looks like this:</p>
<ol type="1">
<li>For any component that requires a grid change, use its native procedure to incorporate the new grid. If the ocean resolution changes, generate a new sea ice grid to match the ocean grid.</li>
<li>For any component that requires a grid change, generate new initial conditions consistent with the grid.</li>
<li>Create a standalone (in NEMS, called side-by-side) compset for the component if one does not exist. Verify correct operation of any component with a new grid and initial conditions running the standalone compset. Create a compset for the target coupled configuration.</li>
<li>Run the coupled configuration compset through initialization in order to generate a mask file on the atmosphere grid that is consistent with ocean and ice mask and grids.</li>
<li>Use the atmosphere mask file to generate correct initial condition files for the atmosphere using the chgres and orographic utilities.</li>
</ol>
<p>A run can now be performed with the changed resolution, using the compset for the coupled configuration.</p>
<p>The steps are explained in more detail below.</p>
<h2>FV3</h2>
<h3>NEMSfv3gfs overall structure</h3>
<p><a href="https://vlab.ncep.noaa.gov/documents/2381028/3236726/NEMSfv3gfs_CodeStructure.pptx/6ef1dc0f-ed12-9bee-4526-1389733c96c0?t=1545316922011">https://vlab.ncep.noaa.gov/documents/2381028/3236726/NEMSfv3gfs_CodeStructure.pptx/6ef1dc0f-ed12-9bee-4526-1389733c96c0?t=1545316922011</a></p>
<h3>Change component grids using their native procedures.</h3>
<h3>Generate new initial conditions for any components with new grids.</h3>
<p><b>MOM</b></p>
<ol type="1">
<li>Use MOM5 build in ocean grid generation utility “MOM5/src/preprocessing/generate_grids/ocean/ocean_grid_generator.csh” to generate ocean grid specify file (grid_spec.nc) with user’s own resolution setting.</li>
<li>Generate ocean initial conditions.</li>
<li>Copy grid_spec.nc file and ocean initial conditions to INPUT directory.</li>
</ol>
<p><b>CICE</b></p>
<ol type="1">
<li>CICE will use the same grid as the ocean component.</li>
<li>CICE requires a grid_file and a kmt_file.</li>
<li>The grid file contains the latitudes and longitudes of the corner points as well as the lengths of the North and East faces of the gridcells and the rotation angle from the curvilinear grid to true latitude-longitude grid.</li>
<li>The kmt_file contains the land/ocean mask where 1s are ocean and 0s are land.</li>
<li>A Fortran code (generateCICEfromFMSgridspec.F90) will take the MOM grid definitions and generate the grid and kmt file for CICE.</li>
</ol>
<p><b>MOM</b></p>
<p>Use “cvtR4p0To5p1” utility to convert NCEP CFSv2 initial conditions (MOM4 based) to UGCS compatible initial conditions (MOM5 based).</p>
<p><b>CICE</b></p>
<ol type="1">
<li>Use the NCAR Command Language (NCL) script to take an initial state from CFS and make it CICE compatible.</li>
<li>ncl convert_cice5.ncl</li>
<li>Expects ice_model.res.nc as input and output is cice5_model.res.nc.</li>
</ol>
<h4>3. Use or create side-by-side (standalone) compsets for any components with new grids and verify correct operation. Create a compset for the target coupled configuration.</h4>
<p><a href="https://docs.google.com/spreadsheets/d/1v9tJb03YuCbwDsXff4M5i6jz4lvBxUrhdImqaGnK_IE/edit#gid=0">This sheet shows the compsets that already exist</a>. (The ones for T574 and T1534 GSM do not) To create a new compset, see the section called How to Add a New Compset. To use CompsetRun, see How to Build &amp; Run.</p>
<h3>Generate a land mask for the atmosphere.</h3>
<p>Masks from the ocean/ice models are interpolated to the atmosphere grid using a local area conservation scheme in the NEMS mediator. The result is a fractional land mask file, field_med_atm_a_land_mask.nc. The mediator sends this mask to the GSM. Grid cells with values equal to 1 can be considered "all land". Grid cells with values between 0 and 1 will eventually be part land, part ocean/ice. However, the GSM atmosphere cannot currently handle cells that are part land, part ocean/ice and must create a binary mask representation using a GSM cutoff parameter. This is hardcoded in the routine GSM/phys/do_physics_one_step.f in the following place: </p>
<pre class="fragment">!   -&gt; Mask
    fldname='land_mask'
    findex = QueryFieldList(ImportFieldsList,fldname)
    if (importFieldsValid(findex) .and.
&amp;   importData(1,1,findex) &gt; -99999.0) then
    do j = 1, lats_node_r
        do i = 1, lonr
            aoi_fld%slimskin(i,j) = 1.0
        if (importData(i,j,findex) \&lt; 0.01) then
            aoi_fld%FICEIN(i,j) = 0.0
            aoi_fld%slimskin(i,j) = 3.0
        endif
        enddo
    enddo
</pre><p>Any cells with a value greater than the cutoff parameter will be land. Currently (for revisions after DREV64441) GSM sets anything greater than 0.01 to land. In GSM, the points that are associated with ocean and ice following the binary land mask and cutoff parameter receive and use ocean and ice exchange field data from those components.</p>
<p>To generate the field_med_atm_a_land_mask.nc file, you must run the coupled system. The mediator will generate that file during initialization. The models must be configured to run on the grids and masks of interest. The initial conditions and other scientific aspects of the model are not important at this point. In this case, it is best if no mediator restarts are used to initialize the system. The goal is to set up a run with the models on the correct grids and masks, to have the coupled system initialize, to have the mediator generate conservative mapping files between grids, for the mediator to interpolate the ocean mask to the atm grid conservatively, and to have that data written to a file. This will all happen during initialization of the system. The model can abort once initialization is complete.</p>
<p>In the previous step, a compset that included the coupled target components and grids was created. Use CompsetRun to run this compset through initialization following <a href="https://esgf.esrl.noaa.gov/projects/couplednems/quick_build_run">How to Build and Run</a>. You may need to setup new PET layouts and decompositions for the new grids. And you need to carefully check the mediator output grid files after this short initial run is complete to verify that the grids in the mediator are consistent with the new grids defined by the models. After the compset runs, you should have the field_med_atm_a_land_mask.nc file in your run directory.</p>
<h3>Run chgres and orographic utilities to get appropriate input files for GSM.</h3>
<p>Additions from (j) 20160406 ... The first step, masks from the ocean/ice models are interpolated to the atmosphere grid using a local area conservation scheme in the mediator. The result is a fractional land mask file, eg., field_med_atm_a_land_mask.nc. Grid cells with values equal to 1 can be considered "all land". Grid cells with values between 0 and 1 will eventually be part land, part ocean/ice. (NB: the NetCDF file, field_med_atm_a_land_mask.nc so far, does not have complete metadata beyond the IMAX, JMAX grid extent and may reverse the grid cell values, for which there is a manual switch - see below) Currently, the GSM atmosphere cannot handle cells that are part land, part ocean/ice and must create a binary mask representation using some cutoff parameter. Any cells with a value greater than the cutoff parameter will be land.</p>
<p>A second step involves running chgres and orography utilities in order to get appropriate input files for GSM. The inputs generated by chgres are siganl and sfcanl, which are initial conditions for the atmospheric model. The siganl file contains the sigma level spherical harmonic spectral coefficients in a binary file of the surface pressure, orography, and remaining model 3D dependent variables and tracers. The sfcanl file contains surface and land surface files in physical space (Gaussian grid) used by the physics component.</p>
<p>In the directory of the files is an ieee file and a GrADS control file that reads and plots the ieee file. The second record of the ieee file is the sea-land mask made by the code. The utility chgres uses the sea-land mask (slm) grib file output made by the orography code, if it is present, with the chgres SLMASK exported variable pointing to the Gaussian grib slm file which in turn was made from landmast.txt input to the orography code from the field_med_atm_a_land_mask.nc netcdf file. In the absence of the export variable SLMASK being set explicitly, the sea-land mask Gaussian file will attempt to be found by chgres in the model fix fields directory and thus be made from the USGS 30 degree elevations, and the UMD 30 degree ocean/lake/land mask file. The same can be expected for the orography file if the export variable OROGRAPHY is not set to a new orography file or the file is not present. The cutoff rule parameter may be changed with recompilation of the orography code.</p>
<p>The sea land mask cutoff parameter (what is the actual parameter name and where is it located?) used to create the set of mask files received on 10/5/15 is believed to be 0, so any cells with value greater than 0 were considered land. This is what has been used to run DREV64441.</p>
<p>After generating the 10/5/15 files, the sea land mask cutoff parameter was set to 0.5, so any cells with a value greater than 0.5 in the fractional netcdf ocean file would be considered land. A new set of mask files was received on 11/17/15 corresponding to the 0.5 cutoff parameter.</p>
<p>Additional files generated by the orography utility and chgres are:</p>
<ul>
<li>mtnvar14_126, which is a gwd/mtn blocking file needed for GSM run time fortran number unit 24</li>
<li>slmgb126, which is the land model file orography code output</li>
<li>orogb126, which is the orography itself</li>
</ul>
<h3>File Format:</h3>
<p>The headers for the signanl/sfcanl file inputs are of the form: </p>
<pre class="fragment">sighdr siganl.gfs.2015040100
jcap
126
lonb
384
latb
190
idate
2015041500
stop
global_sighdr ENDING …
</pre><p>and </p>
<pre class="fragment">sfchdr sfcanl.gfs.2015040100
lonb
384
latb
190
idate
2015041500
</pre><h3>Mask Generation:</h3>
<p>In DREV64441, the mediator sends the land mask field_med_atm_a_land_mask.nc to the GSM atmosphere. There is a parameter in GSM that sets a cutoff point for land. In the version of GSM associated with DREV64441, any point greater than 0.01 is considered a land point. This is approximately consistent with the 0 cutoff value that was used with the chgres and orography utilities. In GSM, the points that are associated with ocean and ice following the binary land mask and cutoff parameter receive and use ocean and ice exchange field data from those components. </p>
<h3>Longer Term:</h3>
<p><em>Consistency Improvement.</em> It would be preferable if the atmosphere did not choose or determine mask values. The mediator would determine ocean/ice and land grid cells, and send appropriate data. Ideally the mask used by the mediator would be automatically consistent with the mask used for chgres and orography file generation.</p>
<p><em>Fractional Cells.</em> Eventually the atmospheric model should be able to handle grid cells that are divided into ice/ocean/land portions. </p>
</div></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.5 </li>
  </ul>
</div>
</body>
</html>
